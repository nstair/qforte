import numpy as np
import qforte as qf


geom = [
    ('C', ( 0.335863334534, -0.638024393629,  0.000000000000)),
    ('H', ( 1.432938652990, -0.620850836653,  0.000000000000)),
    ('C', (-0.296842857597, -1.839541058429,  0.000000000000)),
    ('H', (-1.393739535698, -1.860704460450,  0.000000000000)),
    ('C', ( 0.383204712221, -3.118962195977,  0.000000000000)),
    ('H', ( 1.479554414548, -3.087255036285,  0.000000000000)),
    ('C', (-0.237579216697, -4.313790116847,  0.000000000000)),
    ('H', ( 0.325161369217, -5.249189992705,  0.000000000000)),
    ('H', (-1.329245260575, -4.386987278270,  0.000000000000)),
    ('C', (-0.335863334534,  0.638024393629,  0.000000000000)),
    ('H', (-1.432938652990,  0.620850836653,  0.000000000000)),
    ('C', ( 0.296842857597,  1.839541058429,  0.000000000000)),
    ('H', ( 1.393739535698,  1.860704460450,  0.000000000000)),
    ('C', (-0.383204712221,  3.118962195977,  0.000000000000)),
    ('H', (-1.479554414548,  3.087255036285,  0.000000000000)),
    ('C', ( 0.237579216697,  4.313790116847,  0.000000000000)),
    ('H', ( 1.329245260575,  4.386987278270,  0.000000000000)),
    ('H', (-0.325161369217,  5.249189992705,  0.000000000000)),
]

# geom = [
#     ('C', ( 0.318934151643,  1.838664211757,  0.000000000000)),
#     ('H', ( 1.415980959638,  1.843665440633,  0.000000000000)),
#     ('C', (-0.328238108423,  0.638465784864,  0.000000000000)),
#     ('H', (-1.425382504623,  0.634328966959,  0.000000000000)),
#     ('C', ( 0.328238108423, -0.638465784864,  0.000000000000)),
#     ('H', ( 1.425382504623, -0.634328966959,  0.000000000000)),
#     ('C', (-0.318934151643, -1.838664211757,  0.000000000000)),
#     ('H', (-1.415980959638, -1.843665440633,  0.000000000000)),
#     ('C', (-0.339993000522,  3.116591194820,  0.000000000000)),
#     ('H', (-1.437280937131,  3.109148808007,  0.000000000000)),
#     ('C', ( 0.302193183930,  4.315542102589,  0.000000000000)),
#     ('H', ( 1.399191891261,  4.328262148643,  0.000000000000)),
#     ('C', (-0.368438664361,  5.598270030604,  0.000000000000)),
#     ('H', (-1.465038377840,  5.574093341283,  0.000000000000)),
#     ('C', ( 0.259998191265,  6.789887178283,  0.000000000000)),
#     ('H', ( 1.352081696730,  6.856305536198,  0.000000000000)),
#     ('C', ( 0.339993000522, -3.116591194820,  0.000000000000)),
#     ('H', ( 1.437280937131, -3.109148808007,  0.000000000000)),
#     ('C', (-0.302193183930, -4.315542102589,  0.000000000000)),
#     ('H', (-1.399191891261, -4.328262148643,  0.000000000000)),
#     ('C', ( 0.368438664361, -5.598270030604,  0.000000000000)),
#     ('H', ( 1.465038377840, -5.574093341283,  0.000000000000)),
#     ('C', (-0.259998191265, -6.789887178283,  0.000000000000)),
#     ('H', (-1.352081696730, -6.856305536198,  0.000000000000)),
#     ('H', ( 0.297077214646, -7.728635113123,  0.000000000000)),
#     ('H', (-0.297077214646,  7.728635113123,  0.000000000000)),
# ]

print('\nBuild Geometry')
print('-------------------------')

symm_str = 'c1'
fdocc = 0
fuocc = 0

basis_set = 'cc-pvdz'
avas_atoms_and_atomic_orbs = ['C 2pz']

## ====> Build Qforte Mol with PySCF (using AVAS) <==== ###
mol = qf.system_factory(
    build_type='pyscf', 
    symmetry=symm_str,
    mol_geometry=geom, 
    basis=basis_set, 
    run_fci=True, 
    use_avas=True, #                     <=====
    avas_atoms_or_orbitals=avas_atoms_and_atomic_orbs,
    run_ccsd=False,
    store_mo_ints=True,
    build_df_ham=True,   
    df_icut=1.0e-0,     # Important, must compute here
    num_frozen_uocc = fuocc,
    num_frozen_docc = fdocc,
    build_qb_ham = False,
    )

print(f'The FCI energy from Pyscf:         {mol.fci_energy:12.10f}')
print(f'The SCF energy from Pyscf:         {mol.hf_energy:12.10f}')

alg = qf.QITE(
        mol, 
        reference=mol.hf_reference, 
        computer_type='fci', 
        verbose=0, 
        print_summary_file=0,
        apply_ham_as_tensor=True # leave as False, resource estimaton not implemented for tensor ops
        )

ty = qf.local_timer()
ty.reset()

alg.run(
        beta=1.5,                  # 
        db=0.1,                    #
        dt=0.01,                   #
        use_diis=0,                #
        max_diis_size=0,           #
        use_exact_evolution=0,     #
        expansion_type='All',      # must set to "All" for sqite
        evolve_dfham=0,            #
        random_state=0,            #
        sparseSb=0,                #
        low_memorySb=0,            # low memory Sb resource estimation may be broken
        second_order=1,            #
        selected_pool=1,           #
        t_thresh=1.0e-8,           # 
        cumulative_t=1,            #
        b_thresh=1.0e-6,           # fock computer only
        x_thresh=1.0e-10,          # filters non-contributing operators from fixed pool types 
        conv_thresh=1.0e-3,        # halts evolution once conv threshold reached
        physical_r=1,              #
        use_df_ham_selection=False, # ===> New important df ham for selection option
        folded_spectrum=0,         #
        BeH2_guess=0,              # remove option
        e_shift=None,              #
        update_e_shift=0,          #
        do_lanczos=0,              # broken
        lanczos_gap=2,             #
        realistic_lanczos=1,       #
        fname=None,                # 
        output_path=None,          # for data generation
        print_pool=0,              #
        use_cis_reference=0,       #
        target_root=0,             #
        cis_target_root=0,         #
        )

ty.record("QITE")
print(ty)

Ets = alg._Ets

print('\n')
print(f'The FCI target_root energy from pyscf:     {mol.fci_energy:12.10f}')
print(f'The target_root energy from qite:          {Ets:12.10f}')
print(f'Delta E                                    {np.abs(Ets-mol.fci_energy):12.10f}')

# ===> QITE OUTPUT FOR CURRENT SETTINGS <===

# Build Geometry
# -------------------------
#  ==> PySCF geometry <==
# -------------------------

# C  +0.335863334534  -0.638024393629  +0.000000000000
# H  +1.432938652990  -0.620850836653  +0.000000000000
# C  -0.296842857597  -1.839541058429  +0.000000000000
# H  -1.393739535698  -1.860704460450  +0.000000000000
# C  +0.383204712221  -3.118962195977  +0.000000000000
# H  +1.479554414548  -3.087255036285  +0.000000000000
# C  -0.237579216697  -4.313790116847  +0.000000000000
# H  +0.325161369217  -5.249189992705  +0.000000000000
# H  -1.329245260575  -4.386987278270  +0.000000000000
# C  -0.335863334534  +0.638024393629  +0.000000000000
# H  -1.432938652990  +0.620850836653  +0.000000000000
# C  +0.296842857597  +1.839541058429  +0.000000000000
# H  +1.393739535698  +1.860704460450  +0.000000000000
# C  -0.383204712221  +3.118962195977  +0.000000000000
# H  -1.479554414548  +3.087255036285  +0.000000000000
# C  +0.237579216697  +4.313790116847  +0.000000000000
# H  +1.329245260575  +4.386987278270  +0.000000000000
# H  -0.325161369217  +5.249189992705  +0.000000000000
# converged SCF energy = -308.72271435704



# ------------------------------------
#        ==> AVAS Settings <=== 
# ------------------------------------
#   Basis set:               cc-pvdz
#   n electrons:             58
#   n molecular orbs:        162
#   AVAS atoms and orbs:     ['C 2pz']
#   ncas electrons:          8
#   ncas orbitals:           8



# CASCI E = -308.827833078565  E(CI) = -8.60935050959927  S^2 = 0.0000000
# The FCI energy from Pyscf:         -308.8278330786
# The SCF energy from Pyscf:         -308.7227143570

# -----------------------------------------------------
#      Quantum Imaginary Time Evolution Algorithm   
# -----------------------------------------------------


#                  ==> QITE options <==
# -----------------------------------------------------------
# Computer Type:                            fci
# Trial reference state:                    |1111111100000000>
# Number of Hamiltonian Pauli terms:        0
# Trial state preparation method:           occupation_list
# Trotter order (rho):                      1
# Trotter number (m):                       1
# Use fast version of algorithm:            True


# Total imaginary evolution time (beta):    5.0
# Imaginary time step (db):                 0.1


# Use Folded Spectrum:                      0


# Use CIS Reference:                        0


# Use exact evolutoin:                      0


# Expansion type:                           All
# Use DIIS:                                 0
# Max DIIS size:                            0
# Use selected pool:                        1
# Use cumulative selection:                 1
# Use physical selection:                   1
# Selection time step (dt):                 0.01
# x value threshold:                        1e-10
# Use sparse tensors to solve Sx = b:       0


# Use low memory mode:                      0
# Use 2nd order derivation of QITE:         1
# Do Quantum Lanczos                        0




# ==> Building expansion pool <==
#    beta           E(beta)     N(params)           N(CNOT)          N(measure)
# -------------------------------------------------------------------------------
#    0.000     -308.722714357           0                 0                   0
#    0.100     -308.735652605         148             31648             3203669
#    0.200     -308.746893215         296             41104             6407338
#    0.300     -308.756659929         445             50588             9643392
#    0.400     -308.765150711         596             60176            12944664
#    0.500     -308.772535219         749             69912            16311858
#    0.600     -308.778965796         913             79968            19989015
#    0.700     -308.784573062        1101             91034            25104692
#    0.800     -308.789470174        1318            104014            33166030
#    0.900     -308.793754227        1563            119174            45083204
#    1.000     -308.797508370        1831            136184            60687761
#    1.100     -308.800803706        2119            154652            79806354
#    1.200     -308.803701364        2423            174344           103177763
#    1.300     -308.806253471        2739            195130           128829232
#    1.400     -308.808505061        3063            216694           157065029
#    1.500     -308.810494582        3395            238782           187514130
#    1.600     -308.812255724        3734            261478           218868742
#    1.700     -308.813816882        4077            284742           252650718
#    1.800     -308.815202873        4423            308188           286480857
#    1.900     -308.816435418        4771            331800           320772998
#    2.000     -308.817533005        5119            355486           355515299
#    2.100     -308.818511922        5467            379266           390518928
#    2.200     -308.819386149        5814            403012           424789788
#    2.300     -308.820167921        6157            426454           458881076
#    2.400     -308.820868132        6498            449744           491959098
#    2.500     -308.821496057        6836            472798           524939021
#    2.600     -308.822059947        7171            495682           557389165
#    2.700     -308.822566925        7501            518354           588450024
#    2.800     -308.823023337        7826            540602           619363198
#    2.900     -308.823434507        8145            562438           648292798
#    3.000     -308.823805806        8459            583756           676547369
#    3.100     -308.824141164        8767            604952           704106894
#    3.200     -308.824444496        9068            625606           729533068
#    3.300     -308.824719193        9364            645690           753202397
#    3.400     -308.824968276        9655            665420           777247369
#    3.500     -308.825194208        9937            684724           798828820
#    3.600     -308.825399498       10212            703574           820333848
#    3.700     -308.825586251       10479            721956           840476948
#    3.800     -308.825756258       10738            739536           858989696
#    3.900     -308.825911210       10991            756708           877077998
#    4.000     -308.826052567       11236            773504           894223052
#    4.100     -308.826181741       11475            789698           910188340
#    4.200     -308.826299743       11707            805442           926436509
#    4.300     -308.826407768       11930            820790           940634101
#    4.400     -308.826506696       12145            835466           954801981
#    4.500     -308.826597326       12351            849570           967622540
#    4.600     -308.826680457       12548            862988           978538842
#    4.700     -308.826756853       12740            875778           989906011
#    4.800     -308.826827000       12924            888322          1000478564
#    4.900     -308.826891503       13100            900226          1009952565
# qite converged for convergence threshold 0.001 Hartree


#         Process name            Time (s)             Percent
#        =============       =============       =============
# Total evolution time            908.5957              100.00

#           Total Time            908.5957              100.00





#     Process name        Time (s)         Percent
#    =============   =============   =============
#    c++ selection          0.1821          100.00
# python selection          0.0000            0.00

#       Total Time          0.1821          100.00





#                         ==> QITE summary <==
# -----------------------------------------------------------
# Final QITE Energy:                         -308.8268915032
# Number of operators in pool:               176
# Number of classical parameters used:       13100
# Estimated classical memory usage (GB):     3.840816e-01
# Number of CNOT gates in deepest circuit:   900226
# Number of Pauli term measurements:         1009952565


# The FCI target_root energy from pyscf:     -308.8278330786
# The target_root energy from qite:          -308.8268915032
# Delta E                                    0.0009415753

# From trotter evo of e^-iHdt (is a little different than exact real-time evo!)

# ==> Building expansion pool <==
#    beta           E(beta)     N(params)           N(CNOT)          N(measure)
# -------------------------------------------------------------------------------
#    0.000     -308.722714357           0                 0                   0
#    0.100     -308.735652615         148             31648             3193108
#    0.200     -308.746893222         296             41104             6386216
#    0.300     -308.756662578         446             50616             9644350
#    0.400     -308.765152955         597             60260            12935061
#    0.500     -308.772538863         751             70020            16324911